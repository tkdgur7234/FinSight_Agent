# FinSight_Agent
주식 시장 종합 분석 리포팅 시스템

기능
1. 각종 지표, 경제 뉴스 기반 데일리 시황 리포트
   1-1. Index (25-12-08)
   s&p, nasdaq, russel, bitcoin, ... 등의 일간 변동값
   1-2. S&P 500 Map (25-12-08)
   apiflash 사이트를 통해 s&p 500 map 캡쳐해서 불러오기
   1-3. Released main economy_indicators (25-12-21)
   소비자물가지수(CPI), 생산자물가지수(PPI), 개인소비지출(PCE), 비농업고용지수(NFP), 신규실업수당청구, 소매판매, 기준금리(FOMC)와 같은
   전일 발표되는 주요 지표를 fred api와 forex factory 크롤링을 통해 포스팅
   1-4. Most Imapct Market News (25-12-31)
   전날 시장에 영향을 끼친 주요 뉴스들을 수집 및 제시
   LLM을 통해 핵심 재료를 요약해서 제시
   - Google News RSS 이용해 크롤링 하되 세 단계 전략(현상, 원인, 주도주)으로 나눠서 수집
   - 수집된 기사들 중 중복을 고려해 URL 기준 중복 제거
   - RSS의 title + description만 LLM에 넘겨줘서 토큰 절약
   
2. 관심 종목 집중 모니터링
   2-1. 관심 종목 커뮤니티 감성 분석 (25-01-08)
   레딧을 크롤링하고 ai 활용해 유저들의 종목별 공포 탐욕 지수 확인, 의미있는 게시물만 요약 후 제공
   - 레딧(미국 주식)과 네이버 종토방(한국 주식)을 관심 종목 게시물 50~100개 크롤링
   - JSON DB로 평균 글 리젠 속도를 통한 악재/호재 분석
   - 1차 필터링 : 크롤링 시 인기순 정렬, 글자수/키워드 필터링
   - 2차 필터링 : 핵심 의견 10개로 요약
   - 최종 분석 : 요약된 의견 바탕으로 공포/탐욕 지수 산정 및 원인 분석
   2-2. 관심 종목 뉴스
   - 중복 뉴스 방지를 위한 difflib 라이브러리 사용 (유사도 50% 이상이면 버림)
   RSS에서 5개 기사를 가져오고 중복 걸러내고 남은 최상위 2개만 선택
   - 정밀 시간 필터링 (한국 시간으로 어제 09시 ~ 오늘 09시까지)
   - 유료 뉴스 필터링
3. 이상 거래 감지
   3-1. 관심 종목 대규모 거래 감지
   특정 종목에서 평소와 다른 거대 자금의 유입/유출(블록딜 등)을 장중 차트에서 포착.
   - 상대적 물량 비율 : 5분봉 거래량이 일평균 거래량의 1%(최근 20일)를 초과할 때 감지. (세력 감지)
   - 가격 영향도 판별 : 대량 거래 발생 시점 종가와 30분 후 종가를 비교해 매집/덤핑 구분
   3-2. 주요 종목 내부자 거래 감시
   Nasdaq 100, S&P 500 등 주요 기업 임원들의 미공개 정보 기반 거래 패턴 분석
   - 데이터 필터링 : 장내 매수와 단순 매도만 인정 (스톡옵션 행사 후 당일 매도는 취급X)
   - 매수 집중도 : 직급에 따른 가중치(RoleWeight)를 부여하고 한달 내 3명 이상 매수시 Cluster Buy
   
3. 공시 기반 리스크 모니터링 기능

4. 주간 핫한 테마, 종목 요약 브리핑 시스템 (토요일만 보고)

+ 전일 휴장이었던 날에 대해서는 어떻게 처리할지 고민해보기
+ 
----------------------------------------------
수정 (25-12-21)
기존에는 n8n으로 모두 작업.
         ↓
시스템의 유연성과 확장성을 위해,
데이터 분석 및 리포트 렌더링 로직은 서버를 구축해(FastAPI) 마이크로서비스화 하였으며, 
워크플로우 제어는 n8n을 사용하여 로직과 오케스트레이션을 분리.

my-stock-portfolio/
├── backend/               # Python 서버 (FastAPI)
│   ├── main.py            # 메인 서버 코드
│   ├── routers/           # 포스팅할 엔드포인트 모음
│   ├── services/          # 각종 기능 구현 코드
│   ├── templates/         # 웹 시각화 html
│   ├── requirements.txt   # 라이브러리 목록
│   └── .venv/             # 가상 환경
└── n8n/                   # n8n 관련 파일 (Docker 등)

(25-12-22)
1. n8n 설치 위치와 클론된 폴더 위치가 맞아야함.
2. 가상환경 생성 및 접속
python -m venv venv
source venv/bin/activate
3. 라이브러리 내려받기
pip install -r requirements.txt
4. ".env" 환경변수 파일 생성
api 키 입력
5. 서버 실행
uvicorn main:app --reload

----------------------------

Daily Develop Log

(25-12-23) 
(1) 1-1. Index 구현
(2) 1-2. S&P 500 map 구현
(3) 1-3. Economy_indicators 구현

(25-12-24)
(1) 1-4. Most Imapct Market News 구현
뉴스 검색 시간대 개선 및 llm prompt 개선 작업 중

(25-12-31)
(1) 1-4. Most Imapct Market News
뉴스 정확도 개선

(25-1-2)
(1) 1-1. Index
원달러 환율 추가
(2) 1번 기능 조합해서 웹페이지 구현
jinja2 템플릿 사용
(3) 2, 3번 기능 2번으로 통합 후 소주제 분할
(4) 계획서에 관심 종목 뉴스 기능 추가
후기 : 점점 제미나이 대답이 부정확해지기 시작함. 컨텍스트 엔지니어링 공부하게 됨.

(25-1-5)
(1) 2-1. 관심 종목 커뮤니티 감성 분석 구체화 
글 리젠 속도 파악을 위한 db 사용 고려
커뮤니티 게시물 크롤링은 최신순으로 작업. 9시 리포팅이므로 장후 게시물이 상황을 잘 표현할 것으로 사료됨.
(2) 컨텍스트를 요약해서 핵심만 추출 후 새 컨텍스트로 작업중

(25-1-7)
(1) 2-1. 관심 종목 커뮤니티 네이버 종토방 구현 어려움
이유 : JSON 방식 API 호출을 계획했으나 네이버 증권 측에서 외부 공개 X
HTML 방식으로 선회

(25-1-8)
(1) 2-1. 관심 종목 커뮤니티 감성 분석 구현 및 최적화
평균 글 리젠 속도를 구하기 위해 파일 기반 데이터 축적(JSON DB) 방식 차용
네이버 종토방을 통한 해외주식 구현은 실패.
이유 : 해외주식 검색 시, finance.naver.com/... 에서 m.stock.naver.com/...으로 리디렉션됨.
모바일 페이지는 HTML이 아니라 API 방식이기 때문임. 

(25-1-9)
(1) 2-2. 관심 종목 뉴스 크롤링 기능 구체화 및 구현 완료
1-4 기능 코드 재사용
중복 뉴스 방지를 위한 difflib 라이브러리 사용 (유사도 50% 이상이면 버림)
RSS에서 5개 기사를 가져오고 중복 걸러내고 남은 최상위 2개만 선택
정밀 시간 필터링 (한국 시간으로 어제 09시 ~ 오늘 09시까지)
유료 뉴스 필터링 로직 추가 (블랙리스트 기능)

(25-1-11)
(1) 2-3. 관심 종목 이상 거래 감지 구체화 로직 설계중
기능은 2가지. 관심 종목에 대하여 대규모 거래 감지, 주요 종목(나스닥, snp)에 관하여 내부자 거래 감시

(25-1-15)
(1) 3. 이상 거래 감지 기능 로직 구체화
Financial Modeling Prep (FMP) API로 구현
3-1. 관심 종목 대규모 거래 감지
특정 종목에서 평소와 다른 거대 자금의 유입/유출(블록딜 등)을 장중 차트에서 포착.
 상대적 물량 비율 : 5분봉 하나의 거래량이 최근 20일 일평균 거래량의 1%를 초과할 때 감지. (세력 감지)
 가격 영향도 판별 : 대량 거래 발생 시점 종가와 30분 후 종가를 비교해 매집/덤핑 구분
3-2. 주요 종목 내부자 거래 감시
Nasdaq 100, S&P 500 등 주요 기업 임원들의 미공개 정보 기반 거래 패턴 분석
 지난 24시간동안 새로 올라온 모든 공시 긁어오기
 데이터 필터링 : 장내 매수와 단순 매도만 인정 (스톡옵션 행사 후 당일 매도는 취급X)
 매수 집중도 : 직급에 따른 가중치(RoleWeight)를 부여하고 한달 내 3명 이상 매수시 Cluster Buy

(25-1-18) 3. 이상 거래 감지 기능
(1) fmp api 사용 불가 (해당 사이트 정책 변경)
(2) 3-1. 관심 종목 대규모 거래 감지 기능 수정
5분봉이 일평균 1%를 넘을때 감지 -> 집계되는 사이트 대규모 딜 자체를 크롤링해 빈도수 파악 (일주일, 한달 내에 몇번)
z-score 고려

(25-1-22) 3. 이상 거래 감지 기능
(1) 3-1. 대규모 거래 감지 로직으로 수정
Finviz 크롤링
사용 이유 : Finviz가 대규모 거래 체결 감지하는 방식이 자체적으로 종목의 상대 거래량(RVOL= 현재_거래량/3개월_평균_거래량)을 계산해서 사용하기 때문.
SQLite를 통해 날짜, 종목, 당일 총 거래량, 거래 대금, RVOL(상대 거래량), Z-score를 저장.
이벤트 판단 : 1차로 Finviz Rel_volume > 1.5인 종목만 필터링 후 2차 검증으로 Z-score로 단순 거래량 증가인지 고래 출몰인지 판단.
고래 출몰일(Z-score > 2.0)의 주간 빈도, 월간 빈도를 파악해서 리포팅 (전년도 데이터가 필요하기 때문에 만들어서 사용 or Finviz로 구해서 사용)

* Rel Volume이 있는데 굳이 Z-score까지 사용하는 이유?
- 변동성이 심한 중소형주는 대형주와 달리 단순 RVOL만 사용하면 오판 가능성 존재

(25-1-26) 3. 이상 거래 감지 기능
(1) 3-1. 대규모 거래 감지 로직
Finviz로부터 snp500, nasdaq100, nyse 각 종목당 대규모 거래 상위 60개씩 크롤링
SQLite를 통한 DB 구현, 특정 대형 종목에 한해 1년치 가 데이터 생성
빈도 분석: DB에 SQL 쿼리를 날려 최근 7일/30일 카운트를 계산
Z-score: yfinance로 해당 종목의 작년~현재 일봉 데이터를 가져와 통계적 이상치(Z-score)를 계산
주간/월간(고래 출몰) 빈도수 + Z-score 리포팅
22일자 개발일지와 위 로직 코드 구체화


seen_ticker 정확히 어떻게 작동?




전날 휴장에 대해선 리포팅 어떻게 처리?
캘린더 바탕으로 휴장 미리 기입하고 포스팅 받지 않기

<img width="633" height="903" alt="image" src="https://github.com/user-attachments/assets/1fbfddba-7815-4450-9f2a-4b9c51319921" />
<img width="639" height="829" alt="image" src="https://github.com/user-attachments/assets/9ba404bc-0b10-4627-8b97-f3e2e3767078" />

